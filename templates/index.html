<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrpeddo | Premium Torrent Client</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>Torrpeddo</h1>
            <div id="connection-status" style="font-size: 0.75rem; color: var(--success);">‚óè Connected</div>
        </header>

        <section class="card">
            <div class="controls">
                <input type="text" id="magnet-input" placeholder="Paste magnet link here..."
                    onkeydown="if(event.key === 'Enter') addMagnet()">
                <button onclick="addMagnet()">Add Magnet</button>
                <label for="torrent-upload" class="button"
                    style="background: var(--border); padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; display: inline-block;">Upload
                    .torrent</label>
                <input type="file" id="torrent-upload" style="display: none" onchange="uploadTorrent()">
            </div>
            <div id="toast" class="toast"></div>
            <div class="destination-bar">
                <span>Destination: <span id="current-dir"
                        style="color: var(--text-main);">/Downloads/Torrpeddo</span></span>
                <button onclick="changeDir()"
                    style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: transparent; border: 1px solid var(--border);">Change</button>
            </div>
        </section>

        <section class="torrent-list" id="torrent-container">
            <!-- Torrents will be injected here -->
        </section>
    </div>

    <script>
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const torrents = await response.json();
                renderTorrents(torrents);
            } catch (err) {
                console.error('Failed to fetch status', err);
            }
        }

        async function fetchConfig() {
            const response = await fetch('/api/config');
            const data = await response.json();
            document.getElementById('current-dir').textContent = data.download_dir;
        }

        function renderTorrents(torrents) {
            const container = document.getElementById('torrent-container');
            if (torrents.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No active downloads</div>';
                return;
            }

            container.innerHTML = torrents.map(t => `
                <div class="card torrent-item active">
                    <div class="torrent-header">
                        <div style="font-weight: 600;">${t.name || 'Fetching metadata...'}</div>
                        <div class="badge ${t.is_seeding ? 'badge-seeding' : 'badge-downloading'}">${t.state}</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${t.progress}%"></div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">‚Üì ${t.download_rate.toFixed(1)} kB/s</div>
                        <div class="stat-item">‚Üë ${t.upload_rate.toFixed(1)} kB/s</div>
                        <div class="stat-item">üë• ${t.num_peers} peers</div>
                        <div class="stat-item" style="margin-left: auto;">${t.progress.toFixed(1)}%</div>
                        ${t.is_paused
                    ? `<button onclick="resumeTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--text-main); font-size: 0.75rem; margin-right: 1rem;">Resume</button>`
                    : `<button onclick="pauseTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--text-muted); font-size: 0.75rem; margin-right: 1rem;">Pause</button>`
                }
                        ${t.is_seeding ? `<button onclick="openFolder('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--success); font-size: 0.75rem; margin-right: 1rem;">Open Folder</button>` : ''}
                        ${t.is_seeding ? `<button onclick="removeTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: #ef4444; font-size: 0.75rem;">Remove</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function addMagnet() {
            const magnet = document.getElementById('magnet-input').value;
            if (!magnet) return;

            showToast('Adding magnet link...', 'info');

            try {
                const res = await fetch('/api/add-magnet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ magnet_url: magnet })
                });

                if (res.ok) {
                    document.getElementById('magnet-input').value = '';
                    showToast('Magnet link added successfully', 'success');
                    fetchStatus();
                } else {
                    const error = await res.json();
                    showToast(error.error || 'Failed to add magnet link', 'error');
                }
            } catch (err) {
                showToast('Network error: Could not reach server', 'error');
                console.error(err);
            }
        }

        async function uploadTorrent() {
            const fileInput = document.getElementById('torrent-upload');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const res = await fetch('/api/upload-torrent', {
                method: 'POST',
                body: formData
            });
            if (res.ok) fetchStatus();
        }

        async function removeTorrent(hash) {
            if (confirm('Are you sure you want to remove this torrent?')) {
                await fetch(`/api/remove/${hash}`, { method: 'DELETE' });
                fetchStatus();
            }
        }

        async function changeDir() {
            showToast('Opening folder selector...', 'info');
            try {
                const selRes = await fetch('/api/select-dir', { method: 'POST' });
                const selData = await selRes.json();

                if (selData.cancelled) {
                    showToast('Selection cancelled', 'info');
                    return;
                }

                const newDir = selData.path;
                if (!newDir) return;

                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ download_dir: newDir })
                });

                if (res.ok) {
                    showToast('Download directory updated', 'success');
                    fetchConfig();
                } else {
                    showToast('Invalid directory', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Failed to open selector', 'error');
            }
        }

        async function pauseTorrent(hash) {
            await fetch(`/api/pause/${hash}`, { method: 'POST' });
            fetchStatus();
        }

        async function resumeTorrent(hash) {
            await fetch(`/api/resume/${hash}`, { method: 'POST' });
            fetchStatus();
        }

        async function openFolder(hash) {
            try {
                const res = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ info_hash: hash })
                });
                if (res.ok) {
                    showToast('Opening folder...', 'success');
                } else {
                    const data = await res.json();
                    showToast(data.error || 'Failed to open folder', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Network error', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        fetchConfig();
        setInterval(fetchStatus, 2000);
    </script>
    <style>
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            color: #fff;
            text-align: center;
            border-radius: 0.5rem;
            padding: 1rem;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 0.875rem;
            transition: visibility 0s, opacity 0.5s linear;
            opacity: 0;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: #ef4444;
        }
    </style>
</body>

</html>