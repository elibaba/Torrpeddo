<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrpeddo | Premium Torrent Client</title>
    <link rel="stylesheet" href="static/css/styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Torrpeddo</h1>
            <div id="connection-status" style="font-size: 0.75rem; color: var(--success);">‚óè Connected</div>
        </header>

        <section class="card">
            <div class="controls">
                <input type="text" id="magnet-input" placeholder="Paste magnet link here..."
                    onkeydown="if(event.key === 'Enter') addMagnet()">
                <button onclick="addMagnet()">Add Magnet</button>
                <button onclick="uploadTorrent()">Upload .torrent</button>
            </div>
            <div id="toast" class="toast"></div>
            <div class="destination-bar">
                <span>Destination: <span id="current-dir"
                        style="color: var(--text-main);">/Downloads/Torrpeddo</span></span>
                <button onclick="changeDir()"
                    style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: transparent; border: 1px solid var(--border);">Change</button>
            </div>
        </section>

        <section class="torrent-list" id="torrent-container">
            <!-- Torrents will be injected here -->
        </section>
    </div>

    <script>
        /**
         * renderer/index.html - Frontend Logic
         */

        const pendingRequests = new Map();

        window.electronAPI.receive('python-data', (data) => {
            if (data.id && pendingRequests.has(data.id)) {
                const { resolve, reject } = pendingRequests.get(data.id);
                pendingRequests.delete(data.id);
                if (data.error) reject(data.error);
                else resolve(data.data);
            }
        });

        function sendCommand(command, args = {}) {
            const id = Math.random().toString(36).substr(2, 9);
            return new Promise((resolve, reject) => {
                pendingRequests.set(id, { resolve, reject });
                window.electronAPI.send('to-python', { id, command, args });
            });
        }

        async function fetchStatus() {
            try {
                const torrents = await sendCommand('get_status');
                renderTorrents(torrents);
            } catch (err) {
                console.error('Failed to fetch status', err);
            }
        }

        async function fetchConfig() {
            try {
                const data = await sendCommand('get_config');
                document.getElementById('current-dir').textContent = data.download_dir;
            } catch (err) {
                console.error('Failed to fetch config', err);
            }
        }

        function renderTorrents(torrents) {
            const container = document.getElementById('torrent-container');
            if (!torrents || torrents.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No active downloads</div>';
                return;
            }

            container.innerHTML = torrents.map(t => `
                <div class="card torrent-item ${t.is_cancelled ? 'cancelled' : 'active'}">
                    <div class="torrent-header">
                        <div style="font-weight: 600;">${t.name || 'Fetching metadata...'}</div>
                        <div class="badge ${t.is_cancelled ? 'badge-cancelled' : (t.is_seeding ? 'badge-seeding' : 'badge-downloading')}">${t.state}</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${t.progress}%"></div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">‚Üì ${t.download_rate.toFixed(1)} kB/s</div>
                        <div class="stat-item">‚Üë ${t.upload_rate.toFixed(1)} kB/s</div>
                        <div class="stat-item">üë• ${t.num_peers} peers</div>
                        <div class="stat-item" style="margin-left: auto;">${t.progress.toFixed(1)}%</div>
                        
                        ${!t.is_cancelled ? `
                            ${t.is_paused
                                ? `<button onclick="resumeTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--text-main); font-size: 0.75rem; margin-right: 1rem;">Resume</butto                            : `<button onclick="pauseTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--text-muted); font-size: 0.75rem; margin-right: 1rem;">Pause</button>`
                            }
                            <button onclick="deleteTorrentAndFiles('${t.info_hash}')" style="background: transparent; padding: 0; color: #ef4444; font-size: 0.75rem; margin-right                files</button>
                            <button onclick="cancelTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: #f97316; font-size: 0.75rem; margin-right: 1rem;">Stop</button>
                            ${t.is_seeding ? `<button onclick="openFolder('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--success); font-size: 0.75rem; margin-right: 1rem;">Open Folder</button>` : ''}
                        ` : `
                            <button onclick="deleteTorrentAndFiles('${t.info_hash}')" style="background: transparent; padding: 0; color: #ef4444; font-size: 0.75rem; margin-right: 1rem;">Delete Files</button>
                            <button onclick="removeTorrent('${t.info_hash}')" style="background: transparent; padding: 0; color: var(--text-muted); font-size: 0.75rem;">Dismiss</button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        async function addMagnet() {
            const magnet = document.getElementById('magnet-input').value;
            if (!magnet) return;

            showToast('Adding magnet link...', 'info');

            try {
                const res = await sendCommand('add_magnet', { magnet_url: magnet });
                if (res.success) {
                    document.getElementById('magnet-input').value = '';
                    showToast('Magnet link added successfully', 'success');
                    fetchStatus();
                } else {
                    showToast(res.error || 'Failed to add magnet link', 'error');
                }
            } catch (err) {
                showToast('Bridge error: ' + err, 'error');
                console.error(err);
            }
        }

        async function uploadTorrent() {
            showToast('Opening torrent selector...', 'info');
            try {
                const result = await window.electronAPI.invoke('select-torrent');
                if (result.cancelled) {
                    showToast('Selection cancelled', 'info');
                    return;
                }

                const filepath = result.path;
                showToast('Adding torrent file...', 'info');

                const res = await sendCommand('add_torrent_file', { filepath: filepath });
                if (res.success) {
                    showToast('Torrent file added successfully', 'success');
                    fetchStatus();
                } else {
                    showToast(res.error || 'Failed to add torrent', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Bridge error', 'error');
            }
        }

        async function removeTorrent(hash) {
            if (confirm('Are you sure you want to remove this torrent from the list?')) {
                await sendCommand('remove_torrent', { info_hash: hash });
                fetchStatus();
            }
        }

        async function pauseTorrent(hash) {
            await sendCommand('pause_torrent', { info_hash: hash });
            fetchStatus();
        }

        async function resumeTorrent(hash) {
            await sendCommand('resume_torrent', { info_hash: hash });
            fetchStatus();
        }

        async function cancelTorrent(hash) {
                          nfirm('Stop download and move to canc                    )) {
                const res = await sendCommand('cancel                     info_hash: has                                      if (res.success) {
                                           st('Download stopped', 'info');
                    fetchSta                                       }
            }
        }

        async function deleteTorrent                    
            if (co                        will PERMANENTLY delete the torrent and                        s from disk. Pr                                      ns            awa            ommand('delete_torrent_and_files', { info_has                                if (res.success) {
                    showToast('Torrent and files deleted', 'success');
                    fetchStatus();
                } else {
                    showToast('Failed to delete files', 'error');
                }
            }
        }

        async function openFolder(hash) {
            try {
                const res = await sendCommand('open_folder', { info_hash: hash });
                if (res.success) {
                    showToast('Opening folder...', 'success');
                } else {
                    showToast(res.message || 'Failed to open folder', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Bridge error', 'error');
            }
        }

        async function changeDir() {
                                ng                ctor...', 'info'                    ry {
                                    await window.electronAPI.invoke('se                                             elData.cancelled) {
                         howToast('Selection cancelled', 'info');
                        return                      }

                const newDir = selData.path;
                                 return;

                                        ndCommand('set_config', { download_dir: ne                             if                                             showToast('Download director                    cess');
                                  g();
                } else {
                    showToast('Invalid di                    ');
                                       ch (err) {
                console.error(err);
                             ('Failed to ope                    ror');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        fetchConfig();
        setInterval(fetchStatus, 2000);
    </script>
    <style>
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            color: #fff;
            text-align: center;
            border-radius: 0.5rem;
            padding: 1rem;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 0.875rem;
            transition: visibility 0s, opacity 0.5s linear;
            opacity: 0;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: #ef4444;
        }

        .torrent-item.cancelled {
            border-color: var(--border);
            opacity: 0.8;
            background: rgba(30, 41, 59, 0.4);
        }

        .badge-cancelled {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }
    </style>
</body>

</html>